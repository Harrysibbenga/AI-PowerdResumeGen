---
// src/pages/reset-password.astro (Alternative client-side approach)
import MainLayout from "@/layouts/MainLayout.astro";
import ResetPasswordCard from "@/components/vue/auth/ResetPasswordCard.vue";
---

<MainLayout title="Reset Password | ResumeAI">
    <div
        class="min-h-[calc(100vh-300px)] flex items-center justify-center py-12 px-4"
    >
        <!-- Initially hidden, will be shown by JavaScript -->
        <div id="reset-card-container" style="display: none;">
            <ResetPasswordCard client:load />
        </div>

        <!-- Loading state -->
        <div
            id="loading-state"
            class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-md text-center"
        >
            <div
                class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"
            >
            </div>
            <p class="text-gray-600">Loading...</p>
        </div>

        <!-- Error state (initially hidden) -->
        <div
            id="error-state"
            style="display: none;"
            class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-md"
        >
            <div class="rounded-md bg-red-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg
                            class="h-5 w-5 text-red-400"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">
                            Invalid Reset Link
                        </h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>
                                This reset link is invalid or missing a token.
                                Please request a new password reset.
                            </p>
                        </div>
                        <div class="mt-4">
                            <a
                                href="/forgot-password"
                                class="text-sm font-medium text-red-800 underline hover:text-red-900"
                            >
                                Request new reset link →
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <a
                    href="/login"
                    class="font-medium text-primary-600 hover:text-primary-500 text-sm"
                >
                    ← Back to sign in
                </a>
            </div>
        </div>
    </div>
</MainLayout>

<script>
    // Client-side token extraction and component setup
    document.addEventListener("DOMContentLoaded", function () {
        // Extract token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        console.log("Client-side token extraction:", token);
        console.log("Full URL:", window.location.href);
        console.log("Search params:", window.location.search);

        // Get DOM elements
        const loadingState = document.getElementById("loading-state");
        const errorState = document.getElementById("error-state");
        const resetCardContainer = document.getElementById(
            "reset-card-container",
        );

        // Hide loading state
        loadingState.style.display = "none";

        if (token) {
            // Show reset card and pass token to Vue component
            resetCardContainer.style.display = "block";

            // Wait for Vue component to mount, then pass the token
            setTimeout(() => {
                // Create a custom event with the token
                window.dispatchEvent(
                    new CustomEvent("resetPasswordToken", {
                        detail: { token: token },
                    }),
                );
            }, 100);
        } else {
            // Show error state
            errorState.style.display = "block";
        }
    });
</script>

<style>
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
</style>
